

List of datasets:
 _______________________________________
| 					|
| Bohacek control mouse hippocampus	|
|	replicates 1 to 5		|
|	unpaired reads			|
|	containing: 			|
|		* linear transcripts    |
|_______________________________________|
--> used as a negative control, ideally no circRNAs are quantified
 _______________________________________
| 					|
| 1746 RNAseR mouse hippocampus		|
|	samples D (young) & H (old)	|
|	paired reads			|
|	containing: 			|
|		* circular transcripts	|
|_______________________________________|
--> we have FUCHS bed files: ours & Dieterichs
 _______________________________________
| 					|
| ribozero mouse hippocampus 		|
|	unpaired reads			|
|	containing: 			|
|		* circular transcripts	|
|		* linear transcripts    |
|_______________________________________|


List of file sizes:

- FUCHS bed file: ~10-15K lines
- FUCHS bed file merged: ~16K lines
- DCC CircRNACounts file: ~35K lines --> transcripts are divided into 2 lines
- Salmon quant.sf file: ~150K lines
- CircBase circbase_mouse_mm10.bed file: ~2K lines


List of scripts:

- circtools_master.sh (bash)
	to launch STAR, DCC (detect), FUCHS (reconstruct)
- slurm_circtools_detect_mapping.sh (bash)
	to launch STAR; used inside circtools_master.sh
- gtf_to_bed6_converter.R (R)
	converts GTF file to BED6, used for circtools_master.sh
- bed_index_merger.R (R)
	to merge 2 bed files
- circIndex_generator.sh (bash)
	takes bed file to generate a fasta index of circRNA (bedtools getfasta)
- salmon_fuchs_correlation.R (R)
	correlation of counts generated by Salmon & FUCHS (sample 1746_D)
- 1746_salmon_v_fuchs.R (R)
	generates table of counts generated by Salmon & FUCHS
- 1746_dieterich_v_our.R (R)
	correlation of counts between our and Dieterichs FUCHS bed files
- 1746_dieterich_v_our.Rmd (R markdown)
	creates html document of the above script
- hybrid_bed_generator.R (R)
	to generate a hybrid quantification (FUCHS, DCC, Salmon)
- circbase_comparison.Rmd (R markdown)
	compare how many circRNA we find to CircBase library & vice-versa
- circbase_comparison.html (R markdown html)
	html script created by above script
- dieterich_bed_analysis.Rmd (R markdown)
	analyse dieterich bed files in context of bed_index_merger.R (errors)
- quantification_comparison_rnaser_ribozero.R (R)
	comparison btw. FUCHS, Salmon, RNAseR, RiboZero, w / w/o lin transcript


List of dirs of quantified datasets

- mouse hippocampus RNAseR treated
	
Our:
	/mnt/schratt/tgermade_test/mouse_rnaser_hippocampus (STAR, DCC, FUCHS)

Dieterich:
 	/mnt/schratt/dieterich... (FUCHS)

- mouse hippocampus poly-A selected (Bohacek)
	~/testing/mouse_control_hippocampus/ (STAR, DCC, FUCHS)

- mouse hippocampus ribosomal RNA depleted
	/mnt/schratt/tgermade_test/mouse_ribozero_hippocampus (STAR, DCC, FUCHS)

- rat dendrite/soma
	~/dendrite_ptx/ (STAR)

-------------------------------------------------------------------------

Run all of circtools (with flexbar trimming) on mouse data mouse_RNAseR 1746_D & 1746_H (Hippocampus data). Do the same with /mnt/schratt/mouse_control_hippocampus data (whole Hippocampus data, contains no circRNAs)
 _______________________________________________________________________
| Keep trimming step separate from the detect and reconstruct		|
| pipeline. They're often already trimmed in a previous pipeline.	|
| Also: We want our overarching wrapper to be able to identify  	|
|  paired-end and single-end read datasets (zB by a R1/R2 		|
|  subcategorization)							|
 _______________________________________________________________________

- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -

- 1746_dieterich_v_our.R (R)
Comparison of Dieterichs and our mouse_RNAseR data quantification

make 4 plots:

dieterich  ours
 _______________
|	|	| with linear transcripts
|_______|_______|
|	|	| without linear transcripts
|_______|_______|

Compare correlation of Salmon & FUCHS
Looking at some dataset statistics (Salmon vs Fuchs)
## a) compare Dieterich exon_counts.bed to Dieterich quant.sf made with circular + linear transcript index
## b) compare Dieterich exon_counts.bed to Dieterich quant.sf made with circular transcript index
## c) compare our exon_counts.bed to our quant.sf made with circular + linear transcript index
## d) compare our exon_counts.bed to our quant.sf made with circular transcript index

Fazit:
We can't really trust Salmon. Let's try a version that combines both FUCHS & Salmon to generate circRNA isoform quantifications.

- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -

- hybrid_bed_generator.R (R)
Make hybrid circRNA isoform quantification

Idea:
* Use a FUCHS RNAseR FASTA quantification concatenated with linear transcripts to generate index via Salmon
* Quantify new dataset (not RNAseR treated) via Salmon using concatenated index
* /COMPARE/ FUCHS RNAseR BED quantification /WITH/ new data DCC quantification /AND/ new data Salmon quantification /TO/ create a hybrid list

Why use concatenated index for Salmon quantification? We're just interested in the circular transcripts, and non-matching reads will not be assigned!
--> without linear transcipt assignment, Salmon might clearly assign reads to circ transcripts, which can't be clearly assigned with the linear transcripts included. So, Salmon might confidently assign reads to circs which in reality can't be discerned from linears.

Why is 1746_combined.exon_counts.circIndex.fa so large?
1746_combined.exon_counts.bed (merged bed file of RNAseR treated data) is 23'601 big. 1746_combined.exon_counts.circIndex.fa (after Salmon index) is 47'202 big. It is DOUBLE the size, which makes sense: It uses 2 lines per transcript (1. name 2. sequence).
1746_combined.exon_counts.circIndex.fa does not contain linear transcripts FASTA nor decoys!

- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -

New plans:
- compare our RNAseR treated data quantification (1746_combined.exon_counts.bed) to the public circRNA database (circbase_mouse_mm10.bed from 'circbase.org'):
* how many transcripts match?
* compare the counts we get between matching and non-matching transcripts (score plots)

- compare the RNAseR treated data DCC (CircRNACounts) & the RiboZero data to the public circRNA database (circbase_mouse_mm10.bed)
* how many transcripts match?
* compare the counts we get between matching and non-matching transcripts (score plots)
* are the overlapping (RNAseR & RiboZero) transcripts more readily identified?

- talk with Silvia:
* how do miRNA bind circRNA? with or without AGO?
* which sequence motifs improve binding, and which only improve function? (we're only interested in the binding)

- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -

Run FUCHS on RiboZero data:

We get an empty exon_counts.bed file output. No quantification results using FUCHS. Ribozero contains both linear & circular RNA.

FUCHS parameters used:

-r 2
Circle has to have at least <r> reads to be analysed.
--> We do have elements with > 2 reads

-q 2
MAPQ cutoff, only reads passing this threshold will be written to circle BAM file.
--> We do have elements with mapq scores > 2

- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -


Tasks
#####
- Salmon based on Our RNAseR FUCHS bedfile w/o gentrome
- Salmon based on Our RNAseR FUCHS bedfile + gentrome
- Salmon based on Dieterichs RNAseR FUCHS bedfile w/o gentrome
- Salmon based on Dieterichs RNAseR FUCHS bedfile + gentrome
- Salmon RiboZero based on Our RNAseR FUCHS bedfile w/o gentrome
- Salmon RiboZero based on Our RNAseR FUCHS bedfile + gentrome
- Salmon RiboZero based on Dieterichs RNAseR FUCHS bedfile w/o gentrome
- Salmon RiboZero based on Dieterichs RNAseR FUCHS bedfile + gentrome
--> all of the above with and without --validateMappings option of 'Salmon quant'
- Hybrid method

+ gentrome: 		'.circIndex.fa' and linear transcript FASTA files
	valMap: 	use gentrome.fa (with decoys)
	no_valMap:	use transcripts.fa (without decoys)
w/o gentrome: 		only '.circIndex.fa'


FUCHS quantification:
####################
~/circtools_master.sh ~/mouse_ribozero_hippocampus all /mnt/schratt/mouse_ribozero_hippocampus/ mouse unpaired 24

Salmon quantification:
#####################
/1/: Merge '.exon_counts.bed' files for samples in common batch using 'bed_index_merger.R':
>> Rscript bed_index_merger.R ~/mouse_RNAseR_hippocampus/circtools/03_reconstruct/1746_D/1746_D.exon_counts.bed ~/mouse_RNAseR_hippocampus/circtools/03_reconstruct/1746_H/1746_H.exon_counts_noNeg.bed 1746_combined.exon_counts.bed 24

/2/: Generate '.circIndex.fa' file:
>> ./circIndex_generator.sh ./mouse_RNAseR_hippocampus/1746_combined.exon_counts.bed ./mouse_RNAseR_hippocampus 250

/3/: Concatenate '.circIndex.fa' and linear transcript .fa:
>> cat 1746_combined.exon_counts.circIndex.fa ~/mouse_GENCODEvM21/gentrome.fa > 1746_concatenated.fa

/4/: Run salmon index:
>> cd mouse_ribozero_hippocampus/
>> /common/salmon-0.14/bin/salmon index -t ../mouse_RNAseR_hippocampus/1746_concatenated.fa -d ~/mouse_GENCODEvM21/decoys.txt -i comb_index_1746 -p 20 --gencode

/5/: Run salmon quant (for each sample in batch):
>> /common/salmon-0.14/bin/salmon quant -i comb_index_1746 -l A -p 20 -r <(zcat /mnt/schratt/mouse_ribozero_hippocampus/SRX1641435.trimmed.fastq.gz) --validateMappings -o transcripts_quant_SRX1641435_1746
## Mapping rate = 64.6792%



/mnt/schratt/tgermade_test/salmon/:

mouse_hippocampus_rnaser_our/
	1746_D_H.exon_counts.bed
	1746_D_H.circIndex.fa
	gentrome
		concat.fa
		concat_no_decoy.fa
		index
		index_no_decoy
		quant [H/D/valMap/no_valMap]
	no_gentrome
		index
		quant [H/D/valMap/no_valMap]
mouse_hippocampus_rnaser_dieterich/
	1746_D_H.dieterich.exon_counts.bed
	1746_D_H.dieterich.circIndex.fa
	gentrome
		concat.fa
		concat_no_decoy.fa
		index
		index_no_decoy
		quant [H/D/valMap/no_valMap]
	no_gentrome
		index
		quant [H/D/valMap/no_valMap]
mouse_hippocampus_ribozero/
	info
	gentrome
		quant [s1/s2/our/dieterich/valMap/no_valMap]
	no_gentrome
		quant [s1/s2/our/dieterich/valMap/no_valMap]



We are interested in the following comparisons:
	- RiboZero vs. RNAseR
	- FUCHS vs. Salmon
	- valMap vs. no_valMap
	- gentrome vs. no_gentrome


- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -

/mnt/schratt/tgermade_test/:

files (.bed, .txt)
mouse_GENCODEvM21/
	Gentrome (.fa) & decoys (.txt)
mouse_ribozero_hippocampus/
	.tmp/
	star/
	circtools/
mouse_rnaser_hippocampus/
	.tmp/
	star/
	circtools/
old_mouse_rnaser_control_hippocampus/
	star/
	circtools/
flexbar/
	RNAseR raw files trimmed (.fastq.gz)
salmon/
	bed_index_merger.R*
	circIndex_generator.sh*
	circIndex_generator.sh.save*
	mouse_hippocampus_control_bohacek/
	mouse_hippocampus_ribozero/
	mouse_hippocampus_rnaser_dieterich/
	mouse_hippocampus_rnaser_our/
	test/
scripts/
	1746_salmon_v_fuchs.R*
	1746_salmon_v_fuchs.final.R*
	gtf_to_bed6_converter.R*
	circtools_master.sh*
	slurm_circtools_detect_mapping.sh*
	fuchs_adjust_coordinates.sh*

- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -

When comparing Salmon vs FUCHS data:

We look at: TPM (Salmon) vs. Counts (FUCHS)

And NOT at: NumReads (Salmon) vs. Counts (FUCHS)

Reason:

Salmon quant:
A: 10 x	________ transcript
	-- --- - reads

B: 10 x	_____________________ transcript
	-- --- - -- --- --- - reads

Transcript A is as abundant as B but has much fewer reads assigned. TPM accounts for the difference in transcript length and assigns same value for both A and B.

FUCHS quant:
circA: 10 x	BSJ
	 _______________
	| 	---	|
	| 		|
	|		|
	|_______________|

circB: 10 x		BSJ
	 _______________________________
	| 		---		|
	| 				|
	|				|
	|				|
	|_______________________________|

Only scans for circRNA backsplice junctions. They are the same length for all transcripts. Here the Counts for circA and circB are equal.

- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -


STAR:
	Mapping of reads

DCC:
	Detection: Detect BSJs in dataset, create list of candidate circRNAs &
	estimate circRNA vs. host-linRNA expression

FUCHS:
	Reconstruction: Create list of circRNA isoforms & statistical testing

Salmon:
	Indexing: Create circRNA isoform index (.fa)
	Quantification: Map reads to index, create list of circRNA isoforms


Salmon:
#######

read 		________________________

read k-mers 	___|___|___|___|___|___|___
		k2  k3  k4  ...


transcript	________________________________________________

tx k-mers	___|___|___|___|___|___|___|___|___|___|___|___|___
		k1  k2  k3  k4  ...


read:			transcript 1:		transcript 2:		...
|		k1 _ _ _ _ _ _ _|			|
|_ _ _ _ _ _ _	k2 _ _ _ _ _ _ _|			|
|_ _ _ _ _ _ _	k3 _ _ _ _ _ _ _|  _ _ _ _ _ _ _ _ _ _ _|
|_ _ _ _ _ _ _	k4 _ _ _ _ _ _ _|
		.
		.
		.
		--> read likely originates from tx 1. 


# What happens to reads that fit 2 tx equally well?

		circ_1		circ_2

unambiguous	    8		    4
assignments

		  + 13		   + 7
		   |		     |
		   |_________________|
			   |
ambiguous		   20
assignments	 
		--> get distributed according to the unambiguous ratio
		--> FUCHS discards such instances!


- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -


FUCSH:
------
	STAR --> DCC (selective) --> FUCHS 
		--> circRNA isoform quant

Salmon:
-------
	STAR --> DCC (sensitive) --> FUCHS --> Salmon index --> Salmon quant 
		--> circRNA isoform quant
	
Salmon after first indexing ():
----------------------------
	Salmon quant 
		--> circRNA isoform quant



- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -

How to find Publication from experiment-code.
Look it up through database registration.

NCBI:
-----

GEO			SRA (& ERA of EBI)
---			------------------
 |			 |
GSE-code		Project
 |			 |
GSM-code ______________	SRX-code 		(Experiment)
			 |
			SRR-code		(Run/Replicate)


- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -

FUCHS only uses reads that span BSJ to reconstruct exons. The larger the reads & if they're paired-end, the better it can perform. Since fragment lengths go up to 2k bp and paired-end reads start from both tails of a fragment (& fragments can be anywhere from 200-2k bp long), we get a sequence reconstruction depth of about 2k bp. Extremely large circRNAs can not be reconstructed in their centers.




A  _______________------------___________--------------------_______	  __
   --->							       <----	  --
B  _______________------------________					  __
   --->				 <----					  --
C  ___________								  __
   --->  <----								  --
   _______________	      ___________		     _______________
D |_______________|----------|___________|------------------|_______________|
  |									    |
 BSJ									   BSJ


A: 2k bp long fragment (that covers BSJ). Reads might cover 2 or 3 of 3 exons.

B: Smaller fragment (that covers BSJ). Reads might cover 3 of 3 exons.

C: Small fragment (that covers BSJ). Reads might cover 2 of 3 exons.

D: Exon annotation of 2k+ transcript.


If the reads are long enough, A and B could be assigned to same circRNA.



- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -





